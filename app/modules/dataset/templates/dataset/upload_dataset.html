{% extends "base_template.html" %}

{% block title %}Upload dataset{% endblock %}

{% block content %}

    <h1 class="h2 mb-3"><b>Upload</b> dataset</h1>

    <div class="row">
        <div class="col-12 mb-3">
            <div class="alert alert-warning" role="alert" id="test_zenodo_connection_error" style="display: none">
                <div class="alert-message">
                    <h4 class="alert-heading"><i class="align-middle" data-feather="alert-triangle"></i> Limited
                        connection to the Zenodo API</h4>
                    <p class="p-0 m-0">
                        There seems to be some kind of problem with the Zenodo API and synchronization of your dataset
                        files may not be possible. We will save your files locally to eventually synchronize them with
                        Zenodo. Sorry for the inconvenience, Zenodo is an external service and we can't do
                        anything about it.
                    </p>
                </div>
            </div>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible" role="alert">
                    <div class="alert-message">
                        {{ message }}
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}


    <div class="row">
        <div class="col-12">
            
            <form method="POST" action="{{ url_for('dataset.create_dataset') }}" enctype="multipart/form-data">
                {{ form.hidden_tag() }}

                <div class="card">
                    <div class="card-body">
                        
                        <h1 class="h3 mb-3">Basic info</h1>
                        <div class="row" style="padding-left: 2rem">
                            <div class="col-lg-6 col-xs-12 col-md-12">
                                <div class="mb-3">
                                    {{ form.title.label(class="form-label") }} *
                                    {{ form.title(class="form-control") }}
                                    {% for error in form.title.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="mb-3">
                                    {{ form.desc.label(class="form-label") }} *
                                    {{ form.desc(rows=4, class="form-control") }}
                                    {% for error in form.desc.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-lg-6 col-6">
                                <div class="mb-3">
                                    {{ form.publication_type.label(class="form-label") }}
                                    {{ form.publication_type(class="form-control") }}
                                </div>
                            </div>
                            <div class="col-lg-6 col-6">
                                <div class="mb-3">
                                    {{ form.publication_doi.label(class="form-label") }}
                                    {{ form.publication_doi(class="form-control") }}
                                    {% for error in form.publication_doi.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    {{ form.tags.label(class="form-label") }}
                                    {{ form.tags(class="form-control") }}
                                    {% for error in form.tags.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <h1 class="h3 mb-3 mt-4">Authors</h1>

                        <div class="alert alert-warning mt-3" role="alert">
                            <strong>Warning!</strong> Authors cannot be edited once the dataset has been uploaded to CervezaHub.
                        </div>

                        <div class="row" style="padding-left: 2rem">
                            <div class="col-12">
                                <div class="mb-3">
                                    <div id="authors">
                                        {% for subform in form.authors %}
                                        <div class="row author" {% if not loop.first %}
                                            style="border:2px dotted #ccc;border-radius:10px;padding:10px;margin:10px 0; background-color: white"
                                            {% endif %}
                                        >
                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.form.name.label(class="form-label") }}
                                                {% if loop.first %}
                                                    {{ subform.form.name(class="form-control", readonly=True, value=(current_user.profile.surname or '') ~ ", " ~ (current_user.profile.name or ''), style="color: black; background-color: #e9ecef;") }}
                                                {% else %}
                                                    {{ subform.form.name(class="form-control") }}
                                                {% endif %}
                                                {% for error in subform.form.name.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>
                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.form.affiliation.label(class="form-label") }}
                                                {% if loop.first %}
                                                    {{ subform.form.affiliation(class="form-control", readonly=True, value=current_user.profile.affiliation or 'Not specified', style="color: black; background-color: #e9ecef;") }}
                                                {% else %}
                                                    {{ subform.form.affiliation(class="form-control") }}
                                                {% endif %}
                                                {% for error in subform.form.affiliation.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>
                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.form.orcid.label(class="form-label") }}
                                                {% if loop.first %}
                                                    {{ subform.form.orcid(class="form-control", readonly=True, value=current_user.profile.orcid or 'Not specified', style="color: black; background-color: #e9ecef;") }}
                                                {% else %}
                                                    {{ subform.form.orcid(class="form-control") }}
                                                {% endif %}
                                                {% for error in subform.form.orcid.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <button type="button" class="btn btn-secondary" id="add_author">Add author</button>
                                </div>
                            </div>
                        </div>
                        
                        <h1 class="h3 mb-3 mt-4">CSV file</h1>
                        <div class="row" style="padding-left: 2rem">
                            <div class="col-12">
                                <div class="mb-3">
                                    {{ form.csv_file.label(class="form-label") }} *
                                    {{ form.csv_file(class="form-control") }}
                                    {% for error in form.csv_file.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <hr>
                        <div style="padding-left: 2rem">
                            <label class="form-check">
                                <input id="agreeCheckbox" class="form-check-input" type="checkbox" value="">
                                <span class="form-check-label" style="font-size: 15px">
                                    I agree to have my CSV dataset automatically uploaded to Zenodo and made available to the public according to the <a
                                        href="https://en.wikipedia.org/wiki/Open_science" target="_blank">Open Science</a> manifesto
                                </span>
                            </label>

                            {{ form.submit(class="btn btn-primary mt-2", id="upload_button", disabled=True) }}
                            
                            <div id="loading" style="display: none">
                                <img width="40px" src="{{ url_for("static", filename="gifs/loading.svg") }}"/>
                                Uploading dataset, please wait...
                            </div>
                        </div>
                        
                    </div>
                </div>
            </form>
        </div>

        </div>

{% endblock %}

{% block scripts %}
    <script src="{{ url_for('zenodo.scripts') }}"></script>
    <script src="{{ url_for('dataset.scripts') }}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const checkbox = document.getElementById('agreeCheckbox');
            const upload_button = document.getElementById('upload_button');
            const form = document.querySelector('form');
            const loadingDiv = document.getElementById('loading');
            
            if (checkbox && upload_button) {
                checkbox.addEventListener('change', function () {
                    upload_button.disabled = !checkbox.checked;
                });
            }
            
            // Show "loading" when submitting
            if (form && upload_button && loadingDiv) {
                form.addEventListener('submit', function() {
                    upload_button.disabled = true;
                    loadingDiv.style.display = 'block';
                });
            }
        });
    </script>
{% endblock %}
