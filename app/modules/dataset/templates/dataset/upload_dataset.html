{% extends "base_template.html" %}

{% block title %}Upload dataset{% endblock %}

{% block content %}

    <h1 class="h2 mb-4"><b><i class="align-middle me-2" data-feather="upload-cloud"></i> Upload</b> Dataset</h1>

    <div class="row">
        <div class="col-12 mb-3">
            <div class="alert alert-warning" role="alert" id="test_zenodo_connection_error" style="display: none">
                <div class="alert-message">
                    <h4 class="alert-heading"><i class="align-middle me-2" data-feather="alert-triangle"></i> Limited
                        Connection to Zenodo API</h4>
                    <p class="p-0 m-0">
                        There seems to be some kind of problem with the Zenodo API and synchronization of your dataset
                        files may not be possible. We will save your files locally to eventually synchronize them with
                        Zenodo. Sorry for the inconvenience, Zenodo is an external service and we can't do
                        anything about it.
                    </p>
                </div>
            </div>
        </div>
    </div>

    {# Bloque de mensajes Flash #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    <div class="alert-message">
                        {{ message }}
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    {# Fin de mensajes Flash #}

    <form method="POST" action="{{ url_for('dataset.create_dataset') }}" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <div class="row">
            
            {# ========================================== #}
            {# SECCIÓN: INFORMACIÓN BÁSICA #}
            {# ========================================== #}
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="card-title"><i class="align-middle me-2" data-feather="info"></i> Basic Information</h3>
                    </div>
                    <div class="card-body">
                        
                        <div class="row">
                            <div class="col-12 mb-3">
                                {{ form.title.label(class="form-label") }} <span class="text-danger">*</span>
                                {{ form.title(class="form-control") }}
                                {% for error in form.title.errors %}
                                    <span class="text-danger">{{ error }}</span>
                                {% endfor %}
                            </div>

                            <div class="col-12 mb-3">
                                {{ form.desc.label(class="form-label") }} <span class="text-danger">*</span>
                                {{ form.desc(rows=4, class="form-control") }}
                                {% for error in form.desc.errors %}
                                    <span class="text-danger">{{ error }}</span>
                                {% endfor %}
                            </div>

                            <div class="col-lg-6 col-md-6 mb-3">
                                {{ form.publication_type.label(class="form-label") }}
                                {{ form.publication_type(class="form-control") }}
                            </div>
                            
                            {# ELIMINADO: form.publication_doi (Related Publication) #}
                            
                            <div class="col-lg-6 col-md-6 mb-3">
                                {{ form.tags.label(class="form-label") }}
                                {{ form.tags(class="form-control", placeholder="e.g. beer, abv, ibu, data science") }}
                                {% for error in form.tags.errors %}
                                    <span class="text-danger">{{ error }}</span>
                                {% endfor %}
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            {# ========================================== #}
            {# SECCIÓN: PERMANENT STORAGE (Zenodo/GitHub) #}
            {# ========================================== #}
            <div class="col-lg-4">
                <div class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">
                            <i class="align-middle me-2" data-feather="cloud-lightning"></i>
                            Permanent storage
                        </h3>
                    </div>
                    <div class="card-body">
                        <p class="card-text">
                            Choose where you want to permanently store and publish your dataset
                            (e.g. to obtain a DOI and make it citable).
                            <hr class="my-3">
                        </p>

                        <div class="mb-3">
                            {{ form.storage_service.label(class="form-label") }}
                            {{ form.storage_service(class="form-select", id="storage_service") }}
                            {% for error in form.storage_service.errors %}
                                <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                        </div>

                        {# BLOQUE FakeNODO: solo aplica a Zenodo #}
                        <div class="mb-3" id="fake-zenodo-block" style="display: none;">
                            <label class="form-label">Zenodo connection (FakeNODO)</label>
                            <div class="d-flex align-items-center">
                                <button type="button"
                                        id="connectFakeZenodoBtn"
                                        class="btn btn-outline-light btn-sm"
                                        style="border-radius: 5px;">
                                    <i data-feather="zap"></i>
                                    Connect to FakeNODO
                                </button>
                                <small id="fakeZenodoStatus"
                                       class="ms-2 text-muted">
                                    Not connected
                                </small>
                            </div>
                            <input type="hidden" id="zenodo_connected"
                                   name="zenodo_connected" value="false">
                            <small class="d-block mt-1 text-muted">
                                You must connect to FakeNODO to be able to publish to Zenodo.
                            </small>
                        </div>

                        <small class="text-muted d-block mt-2">
                            <strong>Zenodo (via FakeNODO)</strong> publishes your dataset with a DOI.
                            <br>
                            <strong>GitHub</strong> stores your dataset CSV inside a GitHub repository.
                        </small>
                    </div>
                </div>
            </div>

        </div>
        
        {# ========================================== #}
        {# SECCIÓN: AUTORES #}
        {# ========================================== #}
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title"><i class="align-middle me-2" data-feather="users"></i> Authors</h3>
            </div>
            <div class="card-body">

                <div class="alert alert-warning" role="alert">
                    <i class="align-middle me-2" data-feather="alert-triangle"></i>
                    <strong>Warning!</strong> Authors cannot be edited once the dataset has been uploaded to CervezaHub.
                </div>

                <div id="authors">
                    {% for subform in form.authors %}
                    <div class="row author mb-3 p-3 border rounded" style="background-color: #f8f9fa;">
                        
                        {# Campo Nombre/Name #}
                        <div class="col-lg-6 col-12 mb-3">
                            {{ subform.form.name.label(class="form-label") }}
                            {% if loop.first %}
                                {{ subform.form.name(class="form-control bg-light", readonly=True, value=(current_user.profile.surname or '') ~ ", " ~ (current_user.profile.name or '')) }}
                            {% else %}
                                {{ subform.form.name(class="form-control") }}
                            {% endif %}
                            {% for error in subform.form.name.errors %}
                                <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                        </div>

                        {# Campo Afiliación/Affiliation #}
                        <div class="col-lg-6 col-12 mb-3">
                            {{ subform.form.affiliation.label(class="form-label") }}
                            {% if loop.first %}
                                {{ subform.form.affiliation(class="form-control bg-light", readonly=True, value=current_user.profile.affiliation or 'Not specified') }}
                            {% else %}
                                {{ subform.form.affiliation(class="form-control") }}
                            {% endif %}
                            {% for error in subform.form.affiliation.errors %}
                                <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                        </div>

                        {# Campo ORCID #}
                        <div class="col-lg-6 col-12 mb-3">
                            {{ subform.form.orcid.label(class="form-label") }}
                            {% if loop.first %}
                                {{ subform.form.orcid(class="form-control bg-light", readonly=True, value=current_user.profile.orcid or 'Not specified') }}
                            {% else %}
                                {{ subform.form.orcid(class="form-control") }}
                            {% endif %}
                            {% for error in subform.form.orcid.errors %}
                                <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                        </div>
                        
                        {# Botón de Eliminar para autores adicionales #}
                        {% if not loop.first %}
                        <div class="col-12 d-flex justify-content-end">
                            <button type="button" class="btn btn-sm btn-danger remove-author">Remove Author</button>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                
                <button type="button" class="btn btn-secondary mt-2" id="add_author"><i class="align-middle me-2" data-feather="plus"></i> Add Author</button>
            </div>
        </div>
        
        {# ========================================== #}
        {# SECCIÓN: ARCHIVO CSV #}
        {# ========================================== #}
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title"><i class="align-middle me-2" data-feather="database"></i> Dataset CSV File</h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    {{ form.csv_file.label(class="form-label") }} <span class="text-danger">*</span>
                    {{ form.csv_file(class="form-control") }}
                    {% for error in form.csv_file.errors %}
                        <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>

        {# ========================================== #}
        {# SECCIÓN: TÉRMINOS Y ENVÍO #}
        {# ========================================== #}
        <hr class="mt-4 mb-4">
        
        <div class="d-flex flex-column align-items-start">

            <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="agreeCheckbox">
                <label class="form-check-label" for="agreeCheckbox">
                    I agree to publish this dataset in the selected permanent storage service.
                </label>
            </div>
            
            {{ form.submit(class="btn btn-primary mt-3", id="upload_button", disabled=True) }}
            
            <div id="loading" style="display: none" class="mt-2">
                <img width="40px" src="{{ url_for("static", filename="gifs/loading.svg") }}"/>
                Uploading dataset, please wait...
            </div>
        </div>
        
    </form>

{% endblock %}

{% block scripts %}
    <script src="{{ url_for('zenodo.scripts') }}"></script>
    <script src="{{ url_for('dataset.scripts') }}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            feather.replace();

            const storageSelect = document.getElementById('storage_service');
            const fakeBlock = document.getElementById('fake-zenodo-block');
            const connectBtn = document.getElementById('connectFakeZenodoBtn');
            const statusSpan = document.getElementById('fakeZenodoStatus');
            const zenodoConnectedInput = document.getElementById('zenodo_connected');

            const agreeCheckbox = document.getElementById('agreeCheckbox'); 
            const upload_button = document.getElementById('upload_button');
            const form = document.querySelector('form');
            const loadingDiv = document.getElementById('loading');
            const authorsDiv = document.getElementById('authors');

            function updateFakeBlockVisibility() {
                if (!storageSelect || !fakeBlock || !zenodoConnectedInput || !statusSpan) return;

                if (storageSelect.value === 'zenodo') {
                    fakeBlock.style.display = 'block';
                } else {
                    fakeBlock.style.display = 'none';
                    // Reset estado de conexión cuando se cambia a GitHub
                    zenodoConnectedInput.value = 'false';
                    statusSpan.textContent = 'Not connected';
                    statusSpan.classList.remove('text-success', 'text-danger');
                    statusSpan.classList.add('text-muted');
                }
            }

            function updateUploadButtonState() {
                if (!upload_button) return;

                const storage = storageSelect ? storageSelect.value : 'zenodo';
                const agreeOk = !agreeCheckbox || agreeCheckbox.checked;
                let enabled = agreeOk;

                // Si el servicio es Zenodo, además exigimos conexión FakeNODO
                if (enabled && storage === 'zenodo') {
                    enabled = (zenodoConnectedInput && zenodoConnectedInput.value === 'true');
                }

                upload_button.disabled = !enabled;
            }

            // Inicialización estado
            updateFakeBlockVisibility();
            updateUploadButtonState();

            if (storageSelect) {
                storageSelect.addEventListener('change', function () {
                    updateFakeBlockVisibility();
                    updateUploadButtonState();
                });
            }

            if (agreeCheckbox) {
                agreeCheckbox.addEventListener('change', updateUploadButtonState);
            }

            if (connectBtn && zenodoConnectedInput && statusSpan) {
                connectBtn.addEventListener('click', function () {
                    // Opcional: probar conexión real a Zenodo/FakeNODO si existe la función global
                    if (typeof test_zenodo_connection === 'function') {
                        try {
                            test_zenodo_connection();
                        } catch (e) {
                            console.error('Error calling test_zenodo_connection:', e);
                        }
                    }

                    zenodoConnectedInput.value = 'true';
                    statusSpan.textContent = 'Connected (FakeNODO)';
                    statusSpan.classList.remove('text-muted', 'text-danger');
                    statusSpan.classList.add('text-success');

                    updateUploadButtonState();
                });
            }
            
            // Show "loading" when submitting
            if (form && upload_button && loadingDiv) {
                form.addEventListener('submit', function() {
                    upload_button.disabled = true;
                    loadingDiv.style.display = 'block';
                });
            }
            
            // Lógica para eliminar autores dinámicamente
            if (authorsDiv) {
                authorsDiv.addEventListener('click', function(e) {
                    if (e.target.classList.contains('remove-author')) {
                        e.target.closest('.author').remove();
                    }
                });
            }
        });
    </script>
{% endblock %}
